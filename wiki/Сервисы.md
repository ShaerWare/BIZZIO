# Сервисы

5 сервисов бизнес-логики в `app/Services/`.

## RfqScoringService

Расчёт взвешенных баллов заявок RFQ.

### calculateScores(Rfq $rfq): void

Рассчитывает баллы для всех заявок RFQ и обновляет записи в БД.

Алгоритм:
1. Получает все заявки RFQ
2. Для каждой заявки рассчитывает 3 балла:
   - `score_price = 100 × (min_price / bid_price)` — чем ниже цена, тем выше балл
   - `score_deadline = 100 × (min_deadline / bid_deadline)` — чем меньше срок, тем выше
   - `score_advance = 100 - ((bid_advance / max_advance) × 100)` — чем меньше аванс, тем выше
3. Рассчитывает итоговый балл: `total_score = (score_price × weight_price + score_deadline × weight_deadline + score_advance × weight_advance) / 100`
4. Обновляет каждую заявку (score_price, score_deadline, score_advance, total_score)

### determineWinner(Rfq $rfq): ?RfqBid

Возвращает заявку с максимальным `total_score` или null если заявок нет.

---

## RfqProtocolService

Генерация PDF-протокола результатов RFQ.

### generateProtocol(Rfq $rfq): string

1. Загружает: company, bids.company, bids.user, winnerBid
2. Рендерит шаблон `pdfs.rfq-protocol` через DomPDF
3. Сохраняет файл: `storage/app/public/rfq-protocols/protocol_{number}_{timestamp}.pdf`
4. Прикрепляет через Media Library (коллекция 'protocol')
5. Возвращает путь к файлу

---

## AuctionWinnerService

Определение победителя аукциона и управление закрытием.

### determineWinner(Auction $auction): ?AuctionBid

1. Получает первую торговую ставку (тип 'bid', упорядочено по цене ASC)
2. Обновляет статус ставки на 'winner'
3. Обновляет аукцион: status='closed', winner_bid_id, trading_end=now()
4. Обёрнуто в транзакцию с rollback при ошибке
5. Возвращает ставку-победителя или null

### closeWithoutWinner(Auction $auction): void

Закрывает аукцион без победителя (когда ставок нет):
- status='closed', trading_end=now()
- Транзакционно с rollback

---

## AuctionProtocolService

Генерация PDF-протокола результатов аукциона.

### generate(Auction $auction): ?string

1. Загружает: company, creator, tradingBids.company, tradingBids.user, winnerBid.company
2. Рендерит шаблон `pdf.auction-protocol` через DomPDF
3. Сохраняет через Media Library (коллекция 'protocol')
4. Возвращает имя файла или null при ошибке
5. Логирует успех/ошибку

---

## NewsFilterService

Фильтрация новостей по ключевым словам и другим критериям.

### applyUserKeywords($query, bool $applyKeywords = false): Builder

Если `applyKeywords=true` и пользователь авторизован:
1. Получает ключевые слова пользователя (`User->keywords()`)
2. Применяет `News::searchByKeywords($keywords, 'all')` (AND-логика)

### getFilteredNews(array $filters = [], int $perPage = 20): LengthAwarePaginator

Фильтры:
- `source_id` — ID RSS-источника
- `date` — дата публикации
- `apply_keywords` — boolean, применить ключевые слова

Сортировка: по `published_at` DESC.

Возвращает пагинированный результат.
