# Событийная архитектура

9 доменных событий, 9 слушателей, 10 уведомлений. Все события регистрируются в `AppServiceProvider@registerEventListeners()`.

## Схема

```
Действие пользователя
  → Event (доменное событие)
    → Listener (слушатель)
      → Notification (database + mail)
        → Получатели (модераторы, админы, пользователи)
```

## Матрица событий

| Событие | Слушатель | Уведомление | Получатели |
|---------|-----------|-------------|------------|
| ProjectInvitationSent | SendProjectInvitationNotification | ProjectInvitationNotification | Модераторы приглашённой компании |
| TenderInvitationSent | SendTenderInvitationNotification | TenderInvitationNotification | Модераторы приглашённой компании |
| TenderClosed | SendTenderClosedNotification | TenderClosedNotification | Все участники (с флагом isWinner) |
| AuctionTradingStarted | SendAuctionTradingStartedNotification | AuctionTradingStartedNotification | Модераторы участвующих компаний |
| CommentCreated | SendCommentNotification | NewCommentNotification | Модераторы всех компаний-участников проекта (кроме автора) |
| CompanyCreated | SendCompanyCreatedNotification | CompanyCreatedNotification | Все администраторы платформы |
| ProjectUserInvited | SendProjectUserInvitedNotification | ProjectUserInvitedNotification | Приглашённый пользователь |
| ProjectJoinRequestCreated | SendProjectJoinRequestNotification | ProjectJoinRequestNotification | Модераторы компании-владельца проекта |
| ProjectJoinRequestReviewed | SendProjectJoinRequestReviewedNotification | ProjectJoinRequestReviewedNotification | Пользователь, подавший запрос |

## События (Events)

Все события в `app/Events/`. Используют trait `Dispatchable`, `InteractsWithSockets`, `SerializesModels`.

### ProjectInvitationSent
```php
public Project $project;
public Company $invitedCompany;
```
Срабатывает: при добавлении компании-участника в проект.

### TenderInvitationSent
```php
public Model $tender;      // Rfq или Auction
public Company $invitedCompany;
public string $tenderType; // 'rfq' или 'auction'
```
Срабатывает: при приглашении компании в закрытый тендер.

### TenderClosed
```php
public Model $tender;
public string $tenderType;
public ?int $winnerCompanyId;
```
Срабатывает: при закрытии RFQ или аукциона (через CloseRfqJob/CloseAuctionJob).

### AuctionTradingStarted
```php
public Auction $auction;
```
Срабатывает: при переходе аукциона в фазу торгов (status → trading).

### CommentCreated
```php
public Comment $comment;
```
Срабатывает: при создании комментария в проекте.

### CompanyCreated
```php
public Company $company;
```
Срабатывает: при регистрации новой компании. Уведомляет всех администраторов.

### ProjectUserInvited
```php
public Project $project;
public User $invitedUser;
public User $invitedBy;
```
Срабатывает: при добавлении пользователя в команду проекта.

### ProjectJoinRequestCreated
```php
public ProjectJoinRequest $joinRequest;
```
Срабатывает: при подаче запроса на вступление в проект.

### ProjectJoinRequestReviewed
```php
public ProjectJoinRequest $joinRequest;
public string $decision; // 'approved' или 'rejected'
```
Срабатывает: при рассмотрении запроса на вступление.

## Уведомления (Notifications)

Все уведомления доставляются по двум каналам:
1. **database** — сохраняется в таблицу `notifications`, отображается в колокольчике
2. **mail** — отправляется на email пользователя

### Формат email-уведомлений
- Тема: русскоязычная, содержит название сущности
- Тело: MailMessage с action-кнопкой (ссылка на страницу)
- Отправитель: `noreply@bizzio.ru` (Beget SMTP)

### Формат database-уведомлений
Каждое уведомление сохраняет массив данных:
```php
[
    'type' => 'tender_closed',         // Тип уведомления
    'tender_type' => 'auction',        // Подтип
    'tender_id' => 42,                 // ID сущности
    'tender_number' => 'А-260223-0001',
    'tender_title' => 'Закупка бетона',
    'is_winner' => true,               // Доп. данные
    'url' => '/auctions/42',           // Ссылка
]
```

### TenderClosedNotification — особая логика
Для каждого участника определяется, является ли он победителем:
- Победитель: "Поздравляем! Ваша компания определена победителем!"
- Проигравший: "К сожалению, ваша заявка не стала победителем."

### AuctionTradingStartedNotification — анонимный код
В уведомлении каждому участнику показывается его `anonymous_code` — 4-символьный код (2 буквы + 2 цифры), который используется в торгах вместо названия компании.
