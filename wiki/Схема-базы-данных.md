# Схема базы данных

PostgreSQL 14. 41 миграция. Все таблицы с timestamps.

## ER-диаграмма (текстовая)

```
User ←──→ Company          (many-to-many: company_user, pivot: role, can_manage_moderators)
User ────→ Company          (one-to-many: created_by)
User ←──→ Project           (many-to-many: project_user, pivot: role, company_id)
User ────→ Post              (one-to-many)
User ────→ Comment           (one-to-many)
User ────→ UserKeyword       (one-to-many)
User ────→ CompanyJoinRequest(one-to-many)

Company ────→ Project        (one-to-many: owner)
Company ←──→ Project         (many-to-many: company_project, pivot: role, reviews, ratings)
Company ────→ Rfq            (one-to-many: organizer)
Company ────→ Auction        (one-to-many: organizer)
Company ────→ RfqBid         (one-to-many: bidder)
Company ────→ AuctionBid     (one-to-many: bidder)

Industry ────→ Company       (one-to-many)

Rfq ────→ RfqBid             (one-to-many)
Rfq ────→ RfqInvitation      (one-to-many)
Rfq ────→ RfqBid             (winner_bid_id, nullable)

Auction ────→ AuctionBid     (one-to-many)
Auction ────→ AuctionInvitation (one-to-many)
Auction ────→ AuctionBid     (winner_bid_id, nullable)

Project ────→ Comment        (one-to-many)
Project ────→ ProjectJoinRequest (one-to-many)
Comment ────→ Comment        (self-ref: parent_id, nested comments)

RSSSource ────→ News         (one-to-many)
```

## Таблицы

### users
| Колонка | Тип | Описание |
|---------|-----|----------|
| id | bigint PK | |
| name | string | Имя пользователя |
| email | string, unique | Email |
| password | string | Хеш пароля |
| provider | string, nullable | OAuth-провайдер (google/yandex) |
| provider_id | string, nullable | ID у провайдера |
| avatar | string, nullable | URL аватара |
| phone | string, nullable | Телефон |
| position | string, nullable | Должность |
| bio | text, nullable | О себе |
| email_verified_at | timestamp, nullable | Дата подтверждения email |
| remember_token | string | |
| timestamps | | |

### companies
| Колонка | Тип | Описание |
|---------|-----|----------|
| id | bigint PK | |
| name | string | Название |
| slug | string, unique | URL-идентификатор (auto-generated) |
| inn | string(10-12), unique | ИНН |
| legal_form | string, nullable | Правовая форма (ООО, АО, ИП, ПАО) |
| logo | string, nullable | Путь к логотипу |
| short_description | string(500), nullable | Краткое описание |
| full_description | text, nullable | Полное описание |
| industry_id | FK → industries, nullable | Отрасль |
| is_verified | boolean, default false | Верифицирована администратором |
| created_by | FK → users | Создатель |
| timestamps + soft_deletes | | |

**Индексы:** inn, is_verified, industry_id, slug

### company_user (pivot)
| Колонка | Тип | Описание |
|---------|-----|----------|
| id | bigint PK | |
| company_id | FK → companies | |
| user_id | FK → users | |
| role | enum('moderator','owner') | Роль пользователя в компании |
| added_by | FK → users, nullable | Кто добавил |
| added_at | timestamp, nullable | Когда добавлен |
| can_manage_moderators | boolean, default false | Может управлять модераторами |

**Unique:** company_id + user_id

### company_join_requests
| Колонка | Тип | Описание |
|---------|-----|----------|
| id | bigint PK | |
| company_id | FK → companies | |
| user_id | FK → users | |
| desired_role | string, nullable | Желаемая роль |
| message | text, nullable | Сообщение |
| status | enum('pending','approved','rejected') | Статус |
| reviewed_by | FK → users, nullable | Кто рассмотрел |
| reviewed_at | timestamp, nullable | Когда рассмотрено |
| review_comment | text, nullable | Комментарий рецензента |

### projects
| Колонка | Тип | Описание |
|---------|-----|----------|
| id | bigint PK | |
| name | string | Название проекта |
| slug | string, unique | URL-идентификатор |
| description | string(500), nullable | Краткое описание |
| full_description | text, nullable | Полное описание |
| avatar | string, nullable | Обложка проекта |
| start_date | date | Дата начала |
| end_date | date, nullable | Дата завершения |
| is_ongoing | boolean | Бессрочный |
| status | enum('active','completed','cancelled') | Статус |
| company_id | FK → companies | Компания-владелец |
| created_by | FK → users | Создатель |
| timestamps + soft_deletes | | |

### company_project (pivot — участники-компании)
| Колонка | Тип | Описание |
|---------|-----|----------|
| company_id | FK → companies | |
| project_id | FK → projects | |
| role | enum | Роль: customer, general_contractor, contractor, supplier, consultant |
| participation_description | text, nullable | Описание участия |
| customer_review / customer_rating | text / int(1-5) | Отзыв заказчика |
| participant_review / participant_rating | text / int(1-5) | Отзыв участника |

### project_user (pivot — участники-пользователи)
| Колонка | Тип | Описание |
|---------|-----|----------|
| project_id | FK → projects | |
| user_id | FK → users | |
| company_id | FK → companies | От какой компании |
| role | enum('admin','moderator','member') | Роль в проекте |
| added_by | FK → users, nullable | Кто добавил |
| added_at | timestamp, nullable | |

### project_join_requests
Структура аналогична company_join_requests, с добавлением company_id.

### project_comments
| Колонка | Тип | Описание |
|---------|-----|----------|
| id | bigint PK | |
| project_id | FK → projects | |
| user_id | FK → users | |
| body | text | Текст комментария |
| parent_id | FK → project_comments, nullable | Родительский комментарий (вложенные ответы) |
| timestamps + soft_deletes | | |

### rfqs (Запросы цен)
| Колонка | Тип | Описание |
|---------|-----|----------|
| id | bigint PK | |
| number | string, unique | Номер: К-ГГММДД-0001 |
| title | string | Заголовок |
| description | text, nullable | Описание |
| company_id | FK → companies | Организатор |
| created_by | FK → users | Создатель |
| type | enum('open','closed') | Тип: открытый/закрытый |
| currency | string(3), default 'RUB' | Валюта |
| start_date | timestamp | Начало приёма заявок |
| end_date | timestamp | Окончание приёма заявок |
| weight_price | decimal(5,2), default 50 | Вес критерия «цена» (%) |
| weight_deadline | decimal(5,2), default 30 | Вес критерия «срок» (%) |
| weight_advance | decimal(5,2), default 20 | Вес критерия «аванс» (%) |
| status | enum('draft','active','closed','cancelled') | Статус |
| winner_bid_id | FK → rfq_bids, nullable | Победившая заявка |
| timestamps + soft_deletes | | |

### rfq_bids
| Колонка | Тип | Описание |
|---------|-----|----------|
| id | bigint PK | |
| rfq_id | FK → rfqs | |
| company_id | FK → companies | Компания-участник |
| user_id | FK → users | Подавший заявку |
| price | decimal(15,2) | Цена |
| deadline | int | Срок выполнения (дни) |
| advance_percent | decimal(5,2) | Процент аванса |
| comment | text, nullable | Комментарий |
| score_price | decimal(8,4) | Балл за цену (auto) |
| score_deadline | decimal(8,4) | Балл за срок (auto) |
| score_advance | decimal(8,4) | Балл за аванс (auto) |
| total_score | decimal(8,4) | Итоговый балл (auto) |
| status | enum('pending','accepted','rejected','winner') | |
| timestamps + soft_deletes | | |

**Unique:** rfq_id + company_id (одна компания = одна заявка)

### rfq_invitations
| Колонка | Тип | Описание |
|---------|-----|----------|
| rfq_id | FK → rfqs | |
| company_id | FK → companies | Приглашённая компания |
| invited_by | FK → users | Кто пригласил |
| status | enum('pending','accepted','declined') | |

### auctions (Аукционы)
| Колонка | Тип | Описание |
|---------|-----|----------|
| id | bigint PK | |
| number | string, unique | Номер: А-ГГММДД-0001 |
| title | string | Заголовок |
| description | text, nullable | Описание |
| company_id | FK → companies | Организатор |
| created_by | FK → users | Создатель |
| type | enum('open','closed') | Тип |
| currency | string(3), default 'RUB' | Валюта |
| start_date | timestamp | Начало приёма заявок |
| end_date | timestamp | Окончание приёма заявок |
| trading_start | timestamp, nullable | Начало торгов |
| trading_end | timestamp, nullable | Окончание торгов |
| starting_price | decimal(15,2) | Начальная (максимальная) цена |
| step_percent | decimal(5,2) | Шаг снижения (0.5%–5%) |
| last_bid_at | timestamp, nullable | Время последней ставки |
| status | enum('draft','active','trading','closed','cancelled') | |
| winner_bid_id | FK → auction_bids, nullable | Победившая ставка |
| timestamps + soft_deletes | | |

### auction_bids
| Колонка | Тип | Описание |
|---------|-----|----------|
| id | bigint PK | |
| auction_id | FK → auctions | |
| company_id | FK → companies | |
| user_id | FK → users | |
| price | decimal(15,2) | Цена ставки |
| anonymous_code | string(4), nullable | Анонимный код (2 буквы + 2 цифры) |
| comment | text, nullable | |
| type | enum('initial','bid') | initial = заявка, bid = ставка в торгах |
| status | enum('pending','accepted','rejected','winner') | |
| timestamps + soft_deletes | | |

### auction_invitations
Аналогично rfq_invitations (без invited_by).

### posts
| Колонка | Тип | Описание |
|---------|-----|----------|
| id | bigint PK | |
| user_id | FK → users | Автор |
| body | text | Текст поста |
| timestamps + soft_deletes | | |

### news
| Колонка | Тип | Описание |
|---------|-----|----------|
| id | bigint PK | |
| rss_source_id | FK → rss_sources | Источник |
| title | string | Заголовок |
| description | text, nullable | Текст |
| link | string, unique | URL статьи |
| image | string, nullable | URL изображения |
| published_at | timestamp, nullable | Дата публикации |
| timestamps + soft_deletes | | |

**Full-text index:** title + description

### rss_sources
| Колонка | Тип | Описание |
|---------|-----|----------|
| id | bigint PK | |
| name | string | Название источника |
| url | string | URL RSS-ленты |
| enabled | boolean | Активен |
| parse_interval | int, default 15 | Интервал парсинга (минуты) |
| last_parsed_at | timestamp, nullable | Последний парсинг |
| timestamps + soft_deletes | | |

### user_keywords
| Колонка | Тип | Описание |
|---------|-----|----------|
| id | bigint PK | |
| user_id | FK → users | |
| keyword | string | Ключевое слово |

**Unique:** user_id + keyword

### industries
| Колонка | Тип | Описание |
|---------|-----|----------|
| id | bigint PK | |
| name | string, unique | Название отрасли |
| slug | string, unique | URL-slug |

15 предустановленных: IT, Строительство, Производство, Финансы, Транспорт, Образование, Здравоохранение, Энергетика, Телекоммуникации, Консалтинг, Недвижимость, Сельское хозяйство, Туризм, Медиа/Реклама, Другое.

### Инфраструктурные таблицы
- **activity_log** — Spatie: логи изменений моделей
- **media** — Spatie: файлы/изображения привязанные к моделям
- **sessions** — сессии пользователей (database driver)
- **jobs** / **failed_jobs** — очередь задач (database driver)
- **cache** — кэш (database driver)
- **notifications** — уведомления Laravel
- **password_reset_tokens** — токены сброса пароля
- **orchid_attachments** — вложения Orchid
