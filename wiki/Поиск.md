# Поиск

## Архитектура

Laravel Scout с driver `collection` — поиск выполняется в памяти (не через индекс).

Модели с trait `Searchable`: User, Company, Rfq, Auction, Project.

Каждая модель определяет `toSearchableArray()` и `shouldBeSearchable()`.

## Quick Search (AJAX)

`GET /search/quick?q={query}`

Контроллер: `SearchController@quick`

### Поведение
- Минимум 2 символа
- Возвращает **плоский JSON-массив** (НЕ `{results: [...]}`)
- Дебаунс 300мс (на фронтенде, Alpine.js)
- Результаты в dropdown навигации

### Лимиты по типам

| Тип | Макс. результатов | Поле subtitle |
|-----|-------------------|---------------|
| company | 3 | ИНН |
| project | 3 | Описание |
| rfq | 2 | Номер |
| auction | 2 | Номер |
| user | 3 | Email |

### Формат ответа

```json
[
  {
    "type": "company",
    "type_label": "Компания",
    "id": 5,
    "title": "СтройГрупп",
    "subtitle": "ИНН: 1234567890",
    "url": "/companies/stroygrupp"
  }
]
```

## Full Search

`GET /search?q={query}&type={type}`

Контроллер: `SearchController@index`

### Параметры

| Параметр | Значения | По умолчанию |
|----------|----------|-------------|
| q | string, min 2 chars | required |
| type | users, companies, projects, rfqs, auctions, all | all |

### Поведение
- Рендерит Blade-шаблон `search/index.blade.php`
- Результаты группируются по типу
- Пагинация для каждого типа

## Реализация поиска в моделях

### scopeSearch($query, $search)

Все модели используют единый паттерн:

```php
public function scopeSearch($query, $search)
{
    $op = \DB::getDriverName() === 'pgsql' ? 'ilike' : 'like';
    return $query->where(function ($q) use ($search, $op) {
        $q->where('name', $op, "%{$search}%")
          ->orWhere('inn', $op, "%{$search}%");
    });
}
```

**Важно:**
- PostgreSQL: `ilike` (регистронезависимый)
- SQLite (тесты): `like` (регистрозависимый)
- Это критическая конвенция — нельзя использовать просто `like` в production

### toSearchableArray()

| Модель | Индексируемые поля |
|--------|-------------------|
| User | id, name, email, position, bio |
| Company | id, name, inn, short_description, full_description |
| Project | id, name, description, full_description |
| Rfq | id, number, title, description |
| Auction | id, number, title, description |

### shouldBeSearchable()

| Модель | Условие |
|--------|---------|
| Company | is_verified = true |
| Rfq | status in ['active', 'closed'] |
| Auction | status in ['active', 'trading', 'closed'] |
| User | всегда true |
| Project | всегда true |

## Фронтенд

### Alpine.js Quick Search

В `navigation.blade.php`:
- Input с `@input.debounce.300ms`
- Fetch к `/search/quick?q=...`
- Dropdown с результатами
- Клик по результату → переход по URL
- Клик вне → закрытие dropdown
- Escape → закрытие
