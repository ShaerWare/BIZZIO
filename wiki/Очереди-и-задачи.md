# Очереди и задачи

Queue driver: `database`. 4 Job-класса. Supervisor управляет queue worker в production.

## Jobs

### CloseRfqJob

**Путь:** `app/Jobs/CloseRfqJob.php`

**Параметры:** `Rfq $rfq`

**Retry:** tries=3, timeout=120 сек

**Логика:**
1. Рассчитывает баллы (`RfqScoringService::calculateScores`)
2. Определяет победителя (`RfqScoringService::determineWinner`)
3. Обновляет статус заявки победителя → 'winner'
4. Обновляет RFQ: status='closed', winner_bid_id
5. Генерирует PDF-протокол (`RfqProtocolService::generateProtocol`)
6. Логирует результат

Обрабатывает случай без заявок (закрывает без победителя).

### CloseAuctionJob

**Путь:** `app/Jobs/CloseAuctionJob.php`

**Параметры:** `int $auctionId`

**Логика:**
1. Проверяет что аукцион существует и в статусе 'trading'
2. Определяет победителя (`AuctionWinnerService::determineWinner`) или закрывает без победителя
3. Обновляет аукцион из БД
4. Генерирует PDF-протокол (`AuctionProtocolService::generate`)
5. Логирует каждый шаг

**failed():** Логирует ошибку при провале.

### UpdateAuctionStatuses

**Путь:** `app/Jobs/UpdateAuctionStatuses.php`

**Расписание:** каждую минуту (Scheduler, withoutOverlapping)

**Логика (3 части):**

**Часть 1:** Active → Trading/Cancelled (end_date истёк)
- Есть initial-заявки → status='trading', генерация anonymous_code для участников
- Нет заявок → status='cancelled'

**Часть 2:** Trading → Closed (20 мин без ставок)
- Находит ставку с минимальной ценой → winner
- Обновляет: status='closed', winner_bid_id

**Часть 3:** Trading → Cancelled (24 часа без ставок)
- Нет активности → status='cancelled'

### NotifyAdminOnRSSErrorJob

**Путь:** `app/Jobs/NotifyAdminOnRSSErrorJob.php`

**Параметры:** `RSSSource $source, string $errorMessage`

**Логика:** Находит всех пользователей с ролью 'admin', логирует ошибку.

## Scheduler

Настроен в `bootstrap/app.php` через `withSchedule()`:

| Команда | Расписание | Опции |
|---------|------------|-------|
| `rss:parse` | Каждые 5 минут | withoutOverlapping, background |
| `auctions:update-statuses` | Каждую минуту | withoutOverlapping, background |
| `news:clean-old` | Ежедневно в 02:00 | withoutOverlapping |

## Artisan-команды

| Команда | Описание |
|---------|----------|
| `auctions:check-expired` | Ручная проверка истёкших аукционов |
| `auctions:update-statuses` | Обновление статусов аукционов |
| `rss:parse` | Парсинг RSS-источников |
| `news:clean-old` | Очистка старых новостей |
| `cleanup:test-data` | Интерактивное удаление тестовых компаний (cascade soft-delete) |

## Supervisor (Production)

Конфигурация: `docker/supervisord.conf`

Управляемые процессы:
1. **php-fpm** — PHP FastCGI
2. **nginx** — Веб-сервер
3. **queue-worker** — `php artisan queue:work database` (обработка очереди)
4. **scheduler** — `php artisan schedule:run` каждые 60 сек

Логи:
- Queue worker: `/var/log/queue-worker.log`
- Scheduler: `/var/log/scheduler.log`

Перезапуск очереди: `php artisan queue:restart`

## Testing

В тестах:
- `QUEUE_CONNECTION=sync` — задачи выполняются синхронно
- `Queue::fake()` — для тестирования dispatch без выполнения
- Пример: `Queue::assertPushed(CloseRfqJob::class)`
