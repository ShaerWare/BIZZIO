# Аукционы

Аукцион — механизм закупки методом обратного аукциона (на понижение цены) с торгами в реальном времени и анонимизацией участников.

## Жизненный цикл

```
draft → active → trading → closed
                         → cancelled
```

| Статус | Описание |
|--------|----------|
| draft | Черновик. Можно редактировать и удалять |
| active | Приём первоначальных заявок (между start_date и end_date) |
| trading | Фаза торгов в реальном времени. Участники делают ставки на понижение |
| closed | Закрыт. Определён победитель, сгенерирован PDF-протокол |
| cancelled | Отменён: нет заявок при переходе в торги ИЛИ нет ставок за 24 часа |

## Фазы

### 1. Приём заявок (active)
- Компании подают первоначальные заявки (type='initial')
- Для закрытых аукционов — только приглашённые компании
- Каждой компании присваивается анонимный код

### 2. Торги (trading)
- Начинаются автоматически при наступлении trading_start (или через UpdateAuctionStatuses)
- Участники видят только анонимные коды других участников
- Ставки только на понижение с шагом 0.5%–5% от текущей цены
- Одна компания не может делать две ставки подряд (A6)
- Торги обновляются через long-polling (GET /auctions/{id}/state)

### 3. Закрытие
- Автоматическое: 20 минут без новых ставок → CloseAuctionJob
- Определяется победитель (минимальная цена)
- Генерируется PDF-протокол

## Анонимизация

Каждому участнику при подаче заявки генерируется `anonymous_code` — 4 символа (2 буквы + 2 цифры, например "AB42").

В фазе торгов:
- Организатор видит и названия компаний, и анонимные коды
- Участники видят только анонимные коды

## Ценообразование

- `starting_price` — начальная (максимальная) цена
- `step_percent` — шаг снижения (0.5%–5% от текущей цены)
- `getCurrentPrice()` — текущая минимальная цена (последняя ставка или starting_price)
- `getStepRange()` — допустимый диапазон новой ставки: [currentPrice × 0.95, currentPrice × 0.995]

## Автоматическое управление статусами (UpdateAuctionStatuses)

Job запускается каждую минуту (Scheduler):

1. **Active → Trading/Cancelled**: end_date истёк
   - Есть заявки → status='trading', всем участникам генерируются анонимные коды
   - Нет заявок → status='cancelled'

2. **Trading → Closed**: 20 минут без ставок
   - Определяется победитель (минимальная цена)

3. **Trading → Cancelled**: 24 часа без ставок
   - Отмена из-за отсутствия активности

## Закрытие аукциона (CloseAuctionJob)

1. Проверяет что аукцион в статусе 'trading'
2. Определяет победителя через `AuctionWinnerService::determineWinner()`
3. Если нет ставок — `closeWithoutWinner()`
4. Генерирует PDF-протокол через `AuctionProtocolService::generate()`
5. Отправляет событие `TenderClosed`

## Long-Polling (торговый зал)

Endpoint: `GET /auctions/{id}/state`

Возвращает JSON:
```json
{
  "current_price": 950000.00,
  "bids": [
    {
      "anonymous_code": "AB42",
      "company_name": null,   // null для участников, visible для организатора
      "price": 950000.00,
      "created_at": "2026-02-23T15:30:00"
    }
  ],
  "time_remaining": 1200,
  "status": "trading",
  "last_bid_at": "2026-02-23T15:30:00"
}
```

## PDF-протокол

Генерируется `AuctionProtocolService`:
- Шаблон: `resources/views/pdf/auction-protocol.blade.php`
- Сохраняется через Media Library (коллекция 'protocol')
- Содержит: реквизиты, параметры аукциона, таблицу ставок, победителя

## Маршруты

| Маршрут | Описание |
|---------|----------|
| GET /auctions | Каталог |
| GET /auctions/create | Создание |
| POST /auctions | Сохранение |
| GET /auctions/{id} | Просмотр / торговый зал |
| GET /auctions/{id}/edit | Редактирование (только draft) |
| PUT /auctions/{id} | Обновление |
| DELETE /auctions/{id} | Удаление (только draft) |
| POST /auctions/{id}/activate | Активация |
| POST /auctions/{id}/bids | Подача заявки / ставки |
| POST /auctions/{id}/protocol | Генерация PDF |
| GET /auctions/{id}/state | Long-polling состояния торгов |
| GET /auctions/my/list | Мои аукционы |
| GET /auctions/my/bids | Мои ставки |
| GET /auctions/my/invitations | Мои приглашения |

## Авторизация (AuctionPolicy)

| Действие | Условие |
|----------|---------|
| viewAny | Всегда true |
| view | Открытый — всем; закрытый — организатор/приглашённый |
| create | Пользователь модерирует хотя бы одну компанию |
| update/delete | draft + canManage |
| activate | draft + canManage |
| generateProtocol | closed + canManage |
| placeBid | active/trading + модератор + (приглашён для closed) |

## Валидация (StoreAuctionRequest)

- company_id: required, exists, проверка модерации
- title: required, max 255
- type: required, in:open,closed
- currency: required, in:RUB,USD,CNY
- start_date: required, after:now
- end_date: required, after:start_date
- trading_start: required, after:end_date
- starting_price: required, numeric, min:1
- notification_agreement: required, accepted
- invited_companies: nullable, array (очищается для open-типа)
