# Авторизация и политики

## Система ролей

### Платформенные роли (Orchid)
Управляются через Orchid admin panel. Хранятся в таблице roles.

| Роль | Права |
|------|-------|
| admin | platform.index, platform.systems.roles, platform.systems.users |
| moderator | platform.index |
| subscriber | (без прав) — назначается при OAuth-регистрации |

### Роли в компании (company_user pivot)

| Роль | Описание |
|------|----------|
| owner | Создатель компании. Полный доступ. Нельзя удалить |
| moderator | Управление компанией: RFQ, аукционы, заявки |

Дополнительно: `can_manage_moderators: boolean` — разрешает добавлять/удалять модераторов.

### Роли в проекте (project_user pivot)

| Роль | Описание |
|------|----------|
| admin | Полное управление проектом и участниками |
| moderator | Управление комментариями, приглашение участников |
| member | Просмотр и комментирование |

## Policies

Регистрируются в `AppServiceProvider@registerPolicies()` через `Gate::policy()`.

### RfqPolicy

| Метод | Логика |
|-------|--------|
| viewAny | Всегда true |
| view | Open — всем; Closed — организатор или приглашённый |
| create | `user->isModeratorOfAnyCompany()` |
| update | status='draft' && rfq->canManage(user) |
| delete | status='draft' && rfq->canManage(user) |

### AuctionPolicy

| Метод | Логика |
|-------|--------|
| viewAny | Всегда true |
| view | Open — всем (включая гостей); Closed — организатор/приглашённый |
| create | `user->isModeratorOfAnyCompany()` |
| update | status='draft' && canManage |
| delete | status='draft' && canManage |
| activate | status='draft' && canManage |
| generateProtocol | status='closed' && canManage |
| placeBid | status in [active,trading] && модератор && (приглашён для closed) |

## Модельная авторизация

Методы `canManage(User)` определены на моделях:

### Company::canManage(User)
```
user.id === company.created_by ИЛИ user является модератором компании
```

### Company::isModerator(User)
```
EXISTS в company_user WHERE company_id AND user_id
```

### Company::canManageModerators(User)
```
user.id === company.created_by ИЛИ
user — admin (platform роль) ИЛИ
user в company_user с can_manage_moderators=true
```

### Rfq::canManage(User)
```
user.id === rfq.created_by ИЛИ
user является модератором rfq.company ИЛИ
user — admin
```

### Auction::canManage(User)
Аналогично Rfq::canManage.

### Project::canManage(User)
```
user является модератором project.company ИЛИ
user — admin
```

### Project::isMember(User)
```
EXISTS в project_user WHERE project_id AND user_id
```

### Comment::canManage(User)
```
user.id === comment.user_id ИЛИ user — admin
```

### CompanyJoinRequest::canReview(User)
```
user является модератором company
```

### ProjectJoinRequest::canReview(User)
```
user является admin или moderator проекта
```

## Middleware

| Middleware | Описание |
|-----------|----------|
| auth | Требует аутентификации |
| verified | Требует подтверждённый email |
| guest | Только для неаутентифицированных |

## CSRF

- Обработка TokenMismatchException (419) в `bootstrap/app.php`
- Вместо страницы ошибки — редирект на login с flash-сообщением
- CSRF-токен в meta-теге и Axios заголовке

## HTTPS

Принудительный HTTPS если:
- `APP_ENV=production` ИЛИ
- `APP_URL` начинается с `https://`

Настроено в `AppServiceProvider@configureHttps()`.
