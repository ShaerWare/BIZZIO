# Деплой и инфраструктура

## Стек

| Компонент | Технология | Описание |
|-----------|------------|----------|
| Контейнеризация | Docker + Docker Compose | Все сервисы в контейнерах |
| Reverse Proxy | Caddy 2 | Auto-HTTPS (Let's Encrypt) |
| App Server | PHP 8.2-FPM + Nginx | Внутри одного контейнера |
| Process Manager | Supervisor | php-fpm, nginx, queue, scheduler |
| Database | PostgreSQL 14 Alpine | Отдельный контейнер |
| OS | Linux | VPS, timezone Europe/Moscow |

## Docker Compose

### Контейнеры

| Имя | Image | Описание |
|-----|-------|----------|
| my_project_app | Custom (Dockerfile) | PHP 8.2-FPM + Nginx + Supervisor |
| my_project_db | postgres:14-alpine | PostgreSQL, host port 5435 |
| bizzio-caddy | caddy:2 | Reverse proxy с auto-HTTPS |

### app контейнер
- Base: PHP 8.2-FPM
- Timezone: Europe/Moscow
- Resource limits: 1 CPU, 0.9G RAM
- Port 80 (internal, не exposed напрямую)
- Volume: `.:/var/www` (код приложения)
- Supervisor процессы: php-fpm, nginx, queue worker, scheduler

### db контейнер
- Image: postgres:14-alpine
- Timezone: Europe/Moscow
- Host port: 5435 → Container port: 5432
- Volume: postgres-data (persistent)

### caddy контейнер (override)
- Image: caddy:2
- Ports: 80:80, 443:443
- Volume: Caddyfile, caddy_data, caddy_config
- Networks: app-network + docker_default

## Caddyfile

```
bizzio.ru, www.bizzio.ru {
    reverse_proxy app:80
}
```

Caddy автоматически:
- Получает SSL-сертификат от Let's Encrypt
- Перенаправляет HTTP → HTTPS
- Поддерживает HTTP/2

## Supervisor (docker/supervisord.conf)

| Процесс | Команда | Описание |
|----------|---------|----------|
| php-fpm | php-fpm | FastCGI process manager |
| nginx | nginx -g "daemon off;" | Веб-сервер |
| queue-worker | php artisan queue:work database | Обработка очереди |
| scheduler | php artisan schedule:run | Запуск по расписанию (60 сек) |

Логи:
- Queue: `/var/log/queue-worker.log`
- Scheduler: `/var/log/scheduler.log`

## Deployment

### Пошаговый деплой

```bash
# 1. Обновление кода
git pull origin main

# 2. Установка зависимостей
docker compose exec app composer install --no-dev --optimize-autoloader

# 3. Миграции
docker compose exec app php artisan migrate --force

# 4. Кэширование
docker compose exec app php artisan config:cache
docker compose exec app php artisan route:cache
docker compose exec app php artisan view:cache

# 5. Перезапуск очереди
docker compose exec app php artisan queue:restart
```

### Очистка кэша

```bash
docker compose exec app php artisan config:clear
docker compose exec app php artisan cache:clear
docker compose exec app php artisan route:clear
docker compose exec app php artisan view:clear
```

### Мониторинг

```bash
# Логи очереди
docker compose exec app tail -f /var/log/queue-worker.log

# Логи планировщика
docker compose exec app tail -f /var/log/scheduler.log

# Логи контейнера
docker compose logs -f app

# Логи Caddy
docker compose logs -f caddy
```

## Переменные окружения (.env)

### Критические

| Переменная | Production | Dev |
|------------|-----------|-----|
| APP_ENV | production | local |
| APP_DEBUG | false | true |
| APP_URL | https://bizzio.ru | http://localhost:8080 |
| APP_TIMEZONE | Europe/Moscow | Europe/Moscow |

### База данных

| Переменная | Значение |
|------------|----------|
| DB_CONNECTION | pgsql |
| DB_HOST | db |
| DB_PORT | 5432 |
| DB_DATABASE | laravel |

### Сессии и очереди

| Переменная | Значение |
|------------|----------|
| SESSION_DRIVER | database |
| QUEUE_CONNECTION | database |
| SESSION_SECURE_COOKIE | true (prod) / false (dev) |

### Почта (Beget SMTP)

| Переменная | Значение |
|------------|----------|
| MAIL_HOST | smtp.beget.com |
| MAIL_PORT | 465 |
| MAIL_ENCRYPTION | ssl |
| MAIL_USERNAME | noreply@bizzio.ru |
| MAIL_FROM_ADDRESS | noreply@bizzio.ru |

**Важно:** MAIL_FROM_ADDRESS должен совпадать с MAIL_USERNAME (требование Beget).

### OAuth

| Провайдер | Переменные |
|-----------|------------|
| Google | GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, GOOGLE_REDIRECT_URI |
| Yandex | YANDEX_CLIENT_ID, YANDEX_CLIENT_SECRET, YANDEX_REDIRECT_URI |

### AI Chat

| Переменная | Описание |
|------------|----------|
| GEMINI_API_KEY | API-ключ Google Gemini |

## HTTPS

Принудительно включается если:
- `APP_ENV=production` ИЛИ
- `APP_URL` начинается с `https://`

Настроено в `AppServiceProvider@configureHttps()` через `URL::forceScheme('https')`.

## Swap

VPS с ограниченной RAM (1.9GB). Добавлен 2GB swap:

```bash
fallocate -l 2G /swapfile
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile
echo '/swapfile none swap sw 0 0' >> /etc/fstab
```

## Тестирование

| Параметр | Значение |
|----------|----------|
| DB | SQLite in-memory |
| QUEUE_CONNECTION | sync |
| SESSION_DRIVER | array |
| CACHE_STORE | array |
| BCRYPT_ROUNDS | 4 |

**Важно:** PostgreSQL-специфичные фичи (jsonb, full-text search) не тестируются.

Запуск:
```bash
composer run test                         # Все тесты
php artisan test --filter=TestName        # Конкретный тест
php artisan test --filter=Class::method   # Конкретный метод
```
