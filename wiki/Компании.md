# Компании

Компания — центральная сущность платформы. Все действия (создание RFQ, аукционов, участие в проектах) совершаются от лица компании.

## Жизненный цикл

1. **Регистрация** — пользователь создаёт компанию, указывая ИНН, название, описание
2. **Модерация** — администратор верифицирует компанию (is_verified = true)
3. **Работа** — верифицированная компания доступна в поиске и каталоге

## Роли в компании

Управление через pivot-таблицу `company_user`:

| Роль | Возможности |
|------|------------|
| **owner** | Полный доступ. Назначается при создании. Нельзя удалить |
| **moderator** | Управление компанией, создание RFQ/аукционов, подача заявок |

Дополнительный флаг `can_manage_moderators` — позволяет модератору добавлять/удалять других модераторов.

## Запросы на вступление (Company Join Requests)

Пользователь может подать запрос на вступление в компанию:

```
pending → approved (модератор одобрил → пользователь становится модератором)
        → rejected (модератор отклонил)
```

Ограничения:
- Одновременно может быть только один pending-запрос от пользователя к компании (уникальный индекс)
- Рассматривать запрос может любой модератор компании

## Управление модераторами

Контроллер: `CompanyModeratorController`

- **Добавление** — владелец или модератор с `can_manage_moderators` может пригласить пользователя по email
- **Обновление роли** — изменение роли модератора
- **Удаление** — удаление модератора (владелец не может быть удалён)

## Медиа-файлы

| Коллекция | Тип | Описание |
|-----------|-----|----------|
| logo | image (jpeg, png, gif, webp) | Логотип компании (одиночный) |
| documents | PDF, max 10MB | Учредительные документы |
| photos | image (jpeg, png, gif, webp) | Фотогалерея |

Конвертации: thumb (300×300), medium (800×600), webp.

## Верификация

- `is_verified` — boolean, по умолчанию false
- Устанавливается администратором через Orchid-панель
- Только верифицированные компании отображаются в поиске (`shouldBeSearchable()`)
- Scope `verified()` фильтрует только проверенные компании

## Slug

- Автогенерируется из `name` при создании (boot method)
- Уникальный, используется в URL вместо ID
- Route Model Binding: `Company::getRouteKeyName() → 'slug'`
- URL: `/companies/{slug}`

## Контроллер CompanyController

| Маршрут | Метод | Описание |
|---------|-------|----------|
| GET /companies | index | Каталог с фильтрами (industry, verified, search) |
| GET /companies/create | create | Форма создания |
| POST /companies | store | Создание + загрузка logo/documents |
| GET /companies/{slug} | show | Карточка компании |
| GET /companies/{slug}/edit | edit | Редактирование (создатель/модератор) |
| PUT /companies/{slug} | update | Обновление |
| DELETE /companies/{slug} | destroy | Удаление (только создатель) |
| POST /companies/{slug}/photos | uploadPhotos | Загрузка фото в галерею |
| DELETE /companies/{slug}/photos/{media} | deletePhoto | Удаление фото из галереи |

## Валидация (StoreCompanyRequest)

- name: required, max 255
- inn: required, regex (10 или 12 цифр), unique
- legal_form: nullable, max 255
- logo: nullable, image, max 2MB
- short_description: nullable, max 500
- full_description: nullable
- industry_id: nullable, exists in industries
- documents.*: nullable, PDF, max 10MB
