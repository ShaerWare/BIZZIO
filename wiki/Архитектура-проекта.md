# Архитектура проекта

## Структура каталогов

```
app/
├── Events/              # Доменные события (9 событий)
├── Http/
│   ├── Controllers/     # Веб-контроллеры (18 штук)
│   │   └── Api/V1/      # API-контроллеры (ChatController)
│   └── Requests/        # Form Request валидаторы (12 штук)
├── Jobs/                # Фоновые задачи (4 штуки)
├── Listeners/           # Обработчики событий (9 штук)
├── Models/              # Eloquent-модели (17 штук)
├── Notifications/       # Уведомления database + mail (10 штук)
├── Orchid/              # Админ-панель: экраны и макеты
│   ├── Screens/         # CRUD-экраны (25+ файлов)
│   └── Layouts/         # Табличные/формовые макеты
├── Policies/            # Авторизация (RfqPolicy, AuctionPolicy)
├── Providers/           # AppServiceProvider
├── Services/            # Бизнес-логика (5 сервисов)
└── Socialite/           # Кастомный Yandex OAuth провайдер

bootstrap/
└── app.php              # Middleware, Scheduler, Exception handling

config/
├── platform.php         # Orchid: /admin prefix, guard, middleware
├── scout.php            # Search: collection driver
├── activitylog.php      # Логирование: 365 дней хранения
├── media-library.php    # Файлы: disk public, max 10MB
└── feeds.php            # RSS: cache 3600s

database/
├── factories/           # 3 фабрики (User, Company, Project)
├── migrations/          # 41 миграция
└── seeders/             # 5 сидеров

resources/views/
├── layouts/             # app.blade.php, guest.blade.php, navigation.blade.php
├── components/          # 18 переиспользуемых компонентов
├── partials/dashboard/  # 11 виджетов дашборда
├── companies/           # CRUD-страницы компаний
├── projects/            # CRUD-страницы проектов
├── rfqs/                # CRUD-страницы запросов цен
├── auctions/            # CRUD-страницы аукционов
├── tenders/             # Единый интерфейс тендеров
├── news/                # Лента новостей
├── search/              # Поиск
├── pdf/ & pdfs/         # PDF-шаблоны протоколов
└── auth/                # Аутентификация
```

## Архитектурные паттерны

### MVC + Service Layer
Контроллеры делегируют бизнес-логику в сервисы:
- `RfqScoringService` — расчёт взвешенных баллов заявок
- `AuctionWinnerService` — определение победителя аукциона
- `RfqProtocolService` — генерация PDF-протокола RFQ
- `AuctionProtocolService` — генерация PDF-протокола аукциона
- `NewsFilterService` — фильтрация новостей по ключевым словам

### Event-Driven Architecture
Доменные события регистрируются в `AppServiceProvider@registerEventListeners()`. При возникновении события соответствующий Listener отправляет уведомление по каналам database + mail.

```
Действие → Event → Listener → Notification (database + mail)
```

### Policy-Based Authorization
Авторизация через Laravel Policies:
- `RfqPolicy` — управление RFQ (create/update/delete)
- `AuctionPolicy` — управление аукционами + placeBid + generateProtocol

Модельная авторизация через методы:
- `Company::canManage(User)`, `Company::isModerator(User)`
- `Rfq::canManage(User)`, `Auction::canManage(User)`
- `Project::canManage(User)`, `Project::isMember(User)`

### Soft Deletes
Модели с `SoftDeletes`: Company, Project, Rfq, Auction, RfqBid, AuctionBid, Comment, News, Post, RSSSource.

### Activity Logging
Модели с `LogsActivity` (Spatie): Company, Project, Rfq, Auction, Comment, Post. Логи хранятся 365 дней.

### Media Management
Модели с `InteractsWithMedia` (Spatie): Company (logo, documents, photos), Rfq (technical_specification, protocol), Auction (technical_specification, protocol), Post (photos).

## Ключевые конвенции

### Маршрутизация
Фиксированные маршруты ВСЕГДА определяются ПЕРЕД динамическими `{param}`:
```php
Route::get('/auctions/create', ...);    // ← Сначала create
Route::get('/auctions/{auction}', ...); // ← Потом {auction}
```

### Route Model Binding
- `Company` привязана по `slug` (не `id`): `getRouteKeyName() → 'slug'`
- `Project` привязана по `slug` в маршрутах: `{project:slug}`
- Остальные модели — по `id` (по умолчанию)

### Поиск
PostgreSQL `LIKE` регистрозависим. Все поисковые запросы используют:
```php
$op = \DB::getDriverName() === 'pgsql' ? 'ilike' : 'like';
$query->where('name', $op, "%{$search}%");
```

### Нумерация
- RFQ: `К-ГГММДД-0001` (К = "Коммерческий")
- Auction: `А-ГГММДД-0001` (А = "Аукцион")
- Формат: русская буква + дата (год-месяц-день) + порядковый номер за день

### Брендовые цвета
- Primary: `#28a745` (Bizzio Green / emerald)
- Hover: `#22963e`
- Active: `#1e8537`
- Градиент: `#28a745 → #81b407`
