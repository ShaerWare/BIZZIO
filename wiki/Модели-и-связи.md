# Модели и связи

17 Eloquent-моделей. Все модели в `app/Models/`.

## User

**Extends:** `Orchid\Platform\Models\User` (не стандартный Laravel `Authenticatable`)

**Fillable:** name, email, password, provider, provider_id, avatar, phone, position, bio

**Traits:** HasFactory, Searchable

**Casts:** permissions → array, email_verified_at → datetime, password → hashed

### Связи
| Метод | Тип | Модель | Pivot/FK |
|-------|-----|--------|----------|
| createdCompanies() | HasMany | Company | created_by |
| moderatedCompanies() | BelongsToMany | Company | company_user (role, added_by, added_at, can_manage_moderators) |
| createdProjects() | HasMany | Project | created_by |
| projectMemberships() | BelongsToMany | Project | project_user (company_id, role, added_by, added_at) |
| comments() | HasMany | Comment | |
| companyJoinRequests() | HasMany | CompanyJoinRequest | |
| pendingCompanyRequests() | HasMany | CompanyJoinRequest | status = 'pending' |
| keywords() | HasMany | UserKeyword | |

### Ключевые методы
- `isModeratorOfAnyCompany(): bool` — модерирует хотя бы одну компанию?
- `isModeratorOf(Company): bool` — модератор конкретной компании?
- `getAvatarUrlAttribute(): string` — URL аватара (внешний или локальный)

---

## Company

**Extends:** Model, implements HasMedia

**Fillable:** name, slug, inn, legal_form, logo, short_description, full_description, industry_id, is_verified, created_by

**Traits:** HasFactory, SoftDeletes, InteractsWithMedia, Searchable, AsSource, Filterable, LogsActivity

**Route Model Binding:** `slug` (getRouteKeyName → 'slug')

**Boot:** автогенерация уникального slug при создании/обновлении

### Связи
| Метод | Тип | Модель | Описание |
|-------|-----|--------|----------|
| industry() | BelongsTo | Industry | Отрасль |
| creator() | BelongsTo | User | Создатель (created_by) |
| moderators() | BelongsToMany | User | Модераторы (company_user) |
| joinRequests() | HasMany | CompanyJoinRequest | Запросы на вступление |
| projects() | HasMany | Project | Проекты-владелец |
| participatedProjects() | BelongsToMany | Project | Проекты-участник |
| rfqs() | HasMany | Rfq | Запросы цен |
| rfqBids() | HasMany | RfqBid | Заявки на RFQ |

### Ключевые методы
- `isModerator(User): bool` — пользователь модератор?
- `canManageModerators(User): bool` — может управлять модераторами?
- `hasPendingRequestFrom(User): bool` — есть ожидающий запрос?
- `assignModerator(User, role, addedBy, canManage): void`
- `removeModerator(User): void`
- `scopeVerified($query)` — только верифицированные
- `scopeSearch($query, $search)` — поиск по name, inn (ilike)
- `shouldBeSearchable(): bool` — индексируются только верифицированные

### Media-коллекции
- `logo` — одно изображение (jpeg, png, gif, webp)
- `documents` — PDF файлы
- `photos` — изображения

### Media-конвертации
- `thumb` — 300×300
- `medium` — 800×600
- `webp` — WebP формат

---

## Project

**Fillable:** name, slug, description, full_description, avatar, start_date, end_date, is_ongoing, status, company_id, created_by

**Traits:** HasFactory, LogsActivity, Searchable, SoftDeletes

### Связи
| Метод | Тип | Модель | Описание |
|-------|-----|--------|----------|
| company() | BelongsTo | Company | Владелец |
| creator() | BelongsTo | User | Создатель |
| participants() | BelongsToMany | Company | Компании-участники (company_project) |
| members() | BelongsToMany | User | Пользователи-участники (project_user) |
| joinRequests() | HasMany | ProjectJoinRequest | Запросы на вступление |
| comments() | HasMany | Comment | Корневые комментарии (parent_id = null) |
| allComments() | HasMany | Comment | Все комментарии |

### Роли участников-компаний
customer, general_contractor, contractor, supplier, consultant

### Роли участников-пользователей
admin, moderator, member

### Статусы проекта
active, completed, cancelled

### Ключевые методы
- `canManage(User): bool` — может управлять (модератор компании или admin)
- `isMember(User): bool` — участник проекта?
- `addMember(User, Company, role, addedBy): void`
- `removeMember(User): void`
- `addParticipant(Company, role, description): void`

---

## Rfq (Запрос цен)

**Fillable:** number, title, description, company_id, created_by, type, currency, start_date, end_date, weight_price, weight_deadline, weight_advance, status, winner_bid_id

**Traits:** HasFactory, SoftDeletes, InteractsWithMedia, Searchable, AsSource, Filterable, LogsActivity

**Константы:** `CURRENCIES = ['RUB' => '₽', 'USD' => '$', 'CNY' => '¥']`

### Связи
| Метод | Тип | Модель |
|-------|-----|--------|
| company() | BelongsTo | Company |
| creator() | BelongsTo | User |
| bids() | HasMany | RfqBid |
| invitations() | HasMany | RfqInvitation |
| winnerBid() | BelongsTo | RfqBid |

### Жизненный цикл
`draft → active → closed`

### Ключевые методы
- `generateNumber(): string` — "К-ГГММДД-0001"
- `isActive(): bool` — принимает заявки?
- `isExpired(): bool` — срок истёк?

### Media-коллекции
- `technical_specification` — PDF техзадания (одиночный)
- `protocol` — PDF протокола (одиночный)

---

## Auction (Аукцион)

**Fillable:** number, title, description, company_id, created_by, type, currency, start_date, end_date, trading_start, trading_end, starting_price, step_percent, last_bid_at, status, winner_bid_id

**Traits:** HasFactory, SoftDeletes, InteractsWithMedia, Searchable, AsSource, Filterable, LogsActivity

### Связи
| Метод | Тип | Модель | Описание |
|-------|-----|--------|----------|
| company() | BelongsTo | Company | Организатор |
| creator() | BelongsTo | User | |
| bids() | HasMany | AuctionBid | Все ставки (desc) |
| initialBids() | HasMany | AuctionBid | type = 'initial' |
| tradingBids() | HasMany | AuctionBid | type = 'bid' |
| invitations() | HasMany | AuctionInvitation | |
| winnerBid() | BelongsTo | AuctionBid | |

### Жизненный цикл
`draft → active → trading → closed / cancelled`

### Ключевые методы
- `generateNumber(): string` — "А-ГГММДД-0001"
- `generateAnonymousCode(): string` — 4 символа: 2 буквы + 2 цифры
- `isAcceptingApplications(): bool` — принимает заявки?
- `isTrading(): bool` — идут торги?
- `getCurrentPrice(): float` — текущая минимальная цена
- `getStepRange(): array` — [min: 0.5%, max: 5%] от текущей цены

---

## RfqBid

**Fillable:** rfq_id, company_id, user_id, price, deadline, advance_percent, comment, score_price, score_deadline, score_advance, total_score, status

**Связи:** rfq() → Rfq, company() → Company, user() → User

---

## AuctionBid

**Fillable:** auction_id, company_id, user_id, price, anonymous_code, comment, type, status

**Типы:** initial (заявка), bid (ставка в торгах)

**Связи:** auction() → Auction, company() → Company, user() → User

---

## Comment

**Table:** project_comments

**Fillable:** project_id, user_id, parent_id, body

**Связи:** project() → Project, user() → User, parent() → Comment, replies() → Comment[]

---

## Post

**Fillable:** user_id, body

**Traits:** HasFactory, InteractsWithMedia, LogsActivity, SoftDeletes

**Media:** photos (images)

---

## Остальные модели

- **CompanyJoinRequest** — запрос на вступление в компанию (pending/approved/rejected)
- **ProjectJoinRequest** — запрос на вступление в проект (pending/approved/rejected)
- **RfqInvitation** — приглашение в RFQ (pending/accepted/declined)
- **AuctionInvitation** — приглашение в аукцион (pending/accepted/declined)
- **News** — новость из RSS (rss_source_id, title, description, link, image, published_at)
- **RSSSource** — источник RSS (name, url, enabled, parse_interval, last_parsed_at)
- **UserKeyword** — ключевое слово пользователя для фильтрации новостей
- **Industry** — отрасль (name, slug)
